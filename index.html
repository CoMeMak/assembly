<!--
    This software is distributed under the Apache-2.0 license.
    
    Author(s): 
        - Tudor B. Ionescu (tudor *dot* ionescu +at+ tuwien *dot* ac *dot* at)
        - ...
    
    This software uses and redistributes other open source packages, notably
        - Glumb Robot GUI: https://github.com/glumb/robot-gui (MIT license)
        - JsonEditor: https://github.com/josdejong/jsoneditor (Apache 2.0 license)
        - JQuery + JQuary UI (MIT license)
        - three_js (MIT license)
    
    This software has received financial support from the Austrian Research Promotion Agency (FFG)
    under Grant number 871459 (http://www.comemak.at).
    
    Copyright 2020 - The authors.   
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>a s s e m â›† b l y</title>
  <link href="https://fonts.googleapis.com/css?family=Cute+Font&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Voltaire&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Big+Shoulders+Text:400,500&display=swap" rel="stylesheet">
  <script src="./scripts/jquery-3.4.1.js"></script>
  <script src="./scripts/jquery-ui.js"></script>
  <script src="./scripts/jsoneditor.js"></script>
  <script src="help.json"></script>
    <!--  <script src="../p5.min.js"></script>
    <script src="../addons/p5.dom.min.js"></script>
    <script src="../addons/p5.sound.min.js"></script>
    <script src="kinematik.js"></script>
	<script src="model.js"></script>	
	<script src="sketch.js"></script>	-->
  <link rel="stylesheet" href="./scripts/jsoneditor.css" />
  <link rel="stylesheet" href="./scripts/jquery-ui.css" />
  <link rel="stylesheet" href="draggable.css" />
  <link rel="stylesheet" href="switch.css" />
  
  <script src="js/beautify.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/require.js" charset="utf-8"></script>
  <!-- <script src="/socket.io/socket.io.js"></script> -->

  <script src="vendor/three_js/Three.js"></script>
  <script src="vendor/three_js/Detector.js"></script>
  <script src="vendor/three_js/Stats.js"></script>

  <script src="vendor/threex/THREEx.screenshot.js"></script>
  <script src="vendor/threex/THREEx.FullScreen.js"></script>
  <script src="vendor/threex/THREEx.WindowResize.js"></script>
  <script src="vendor/three_js/OrbitControls.js"></script>
  <script src="vendor/three_js/TransformControls.js"></script>
  <script src="vendor/EventDispatcher.js"></script>
  <script src="js/THREERobot.js"></script>
  <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/theme-monokai.js" type="text/javascript" charset="utf-8"></script>
  
  
  <link href="css/main.css" rel="stylesheet" />

  
  
</head>  
  <script>
    const global = window;
	var ATTACH = false;
	
	var force_val = 0;
	
	function force()
	{
		return (force_val++)%30;
	}
  
    var rotate = true;
  
    function populateSelects()
    {
        var conditions = $(".condition");
        for(var i=0;i<conditions.length;i++)
        {
            var $cond = $(conditions[i]);
            var sel_txt = $cond.find(":selected").text();
            var sel_val = $cond.find(":selected").val();
            $cond.empty();
			
			for (var key in Vars) {
               
               if(sel_txt == key)
               {
                    $cond.append($("<option selected='selected' />").val("Vars." + key).text(key));
               }
               else if((typeof Vars[key]) == "boolean" || (typeof Vars[key]) == "string")
               {
                    $cond.append($("<option />").val("Vars." + key).text(key));
               }
			   
            } 
        }        
        
        var counters = $(".counter");
        for(var i=0;i<counters.length;i++)
        {
            var $cnt = $(counters[i]);
            var sel_txt = $cnt.find(":selected").text();
            var sel_val = $cnt.find(":selected").val();
            $cnt.empty();
			
			for (var key in Vars) {
               
               if(sel_txt == key)
               {
                    $cnt.append($("<option selected='selected' />").val("Vars." + key).text(key));
               }
               else if(Number.isInteger(Vars[key]))
               {
                    $cnt.append($("<option />").val("Vars." + key).text(key));
               }
			   
			   
            } 
        }
        
        var expressions = $(".expression");
        for(var i=0;i<expressions.length;i++)
        {
            var $obj = $(expressions[i]);
            var sel_txt = $obj.find(":selected").text();
            var sel_val = $obj.find(":selected").val();
            $obj.empty();
            
			for (var key in Vars) {
               
               if(sel_txt == key)
               {
                    $obj.append($("<option selected='selected' />").val("Vars." + key).text(key));
               }
               else if(typeof Vars[key] == "string")
               {
                    $obj.append($("<option />").val("Vars." + key).text(key));
               }
			   
			   
            } 
        }
        /*
        var exports = $(".export-var");
        for(var i=0;i<exports.length;i++)
        {
            var $obj = $(exports[i]);
            var sel_txt = $obj.find(":selected").text();
            var sel_val = $obj.find(":selected").val();
            $obj.empty();
            for (var key in Vars) {
               
               if(sel_txt == key)
               {
                    $obj.append($("<option selected />").val("Vars." + key).text(key));
               }
               else
               {
                    $obj.append($("<option />").val("Vars." + key).text(key));
               }
            } 
        }
        */
		$(".draggable, .ui-draggable").on("change", "select", function() {
		   var index = this.selectedIndex;
		   $(this)
			  .find("option")
			  .removeAttr("selected") // Changes the selectedIndex. That's why I saved a copy.
			  .removeAttr("sel")
			  .eq(index)
			  .attr("selected", "selected") // Attributes will get cloned, properties will not.
			  .attr("sel", "true");
		});
    }
  
    var indentation = false;
    function indent()
    {
		
        /*var lis = $('ul.sortable li');
        var keys = [];
        var margin = 2;
        var stop = null;
        for(var i=0;i<lis.length;i++)
        {
            
            if(indentation)
            {   
                $(lis[i]).css("margin-top",margin);
            }
            
            if($(lis[i]).attr("name") == "stop")
            {
                stop = $(lis[i]).offset();
            }
        
            if($(lis[i]).attr("id") != null)
            {
                margin += 12;
                keys.push($(lis[i]).attr("id"));
            }
            
            if(keys.length > 0)
            {
                var key = keys.pop();
                if($(lis[i]).attr("head") == key)
                {
                    margin -= 12;              
                }
                else
                {
                    keys.push(key);
                }
            }           
        }       
        */
      
        var stop = $("li[name='stop']").offset();  
      $("#trash").css({top: stop.top - 6, left: stop.left + 60, position:'absolute'});
    }
  
  function showHelp(ui_item)
  {
        if(event.target.nodeName == 'SELECT')
        {
            return;
        }
        var elem = ui_item.attr("name");
        
        $("#help").show();
        $("#elementName").text(elem);
        
        if(HELP.hasOwnProperty(elem))
        {
            $("#elementHelp").html("<hr size='1' />" + HELP[elem]);
        }
        else
        {
            $("#elementHelp").html("<hr size='1' /> This is a user-defined task. For help, check out the wiki at <a href='#'>" + elem + "</a>.");
        }        
        
  }
  var Task_Backup = null;
  function restoreTask(ui_item)
  {
	if(Task_Backup != null)
	{
		var t = window.Task;
						try
						{
							ui_item.attr("params",btoa(JSON.stringify(t)));
							$("li").removeClass("li-selected");                    
							$("#elementHelp").hide();							
						} 
						catch (e) 
						{
							alert("Input error:" + e);
						}
		window.Task = Task_Backup;
		Task_Backup = null;
	}
  }
  function addClickEvents(ui_item)
  {
    	ui_item.off("click");
		if(ui_item.attr("name") == "gripperClose")
        {
			ui_item.click(function() {
				if(!ui_item.hasClass("li-selected"))
				{
					ATTACH = true;
				}
			});
		}
		else if(ui_item.attr("name") == "gripperOpen")
        {
			ui_item.click(function() {
				if(!ui_item.hasClass("li-selected"))
				{
					ATTACH = false;
				}
			});
		}
        else if(ui_item.attr("name") == "moveTo")
        {
             ui_item.click(function() {
				if(!ui_item.hasClass("li-selected"))
				{
                 var params = JSON.parse(ui_item.attr("params"));
                  $("#robot_connected").prop("checked", false);
                  $("#x").val(params.tcp.x);
                  $("#y").val(params.tcp.y);
                  $("#z").val(params.tcp.z);
                  $("#rx").val(params.tcp.rx);
                  $("#ry").val(params.tcp.ry);
                  $("#rz").val(params.tcp.rz);
                  $("#ParamsContext").click();
                }
             });
             $("#ParamsContext").click();
        }
        else if(ui_item.attr("name") == "moveRelative")
        {
            ui_item.click(function() {
                
              	if(!ui_item.hasClass("li-selected"))
				{
                    $("#ParamsContext").click();
                 	$("#x").val(parseFloat($("#x").val()) + eval(Params.motion.dP.x));
                  	$("#y").val(parseFloat($("#y").val()) + eval(Params.motion.dP.y));
                  	$("#z").val(parseFloat($("#z").val()) + eval(Params.motion.dP.z));
                  	$("#rx").val(parseFloat($("#rx").val()) + eval(Params.motion.dR.rx));
                  	$("#ry").val(parseFloat($("#ry").val()) + eval(Params.motion.dR.ry));
                  	$("#rz").val(parseFloat($("#rz").val()) + eval(Params.motion.dR.rz));
                }
            });
            $("#ParamsContext").click();
        }        
        else if(ui_item.attr("name") == "setParams")
        {
             ui_item.click(function() {
                window.Params = JSON.parse(atob(ui_item.attr("params")));
                $("#ParamsContext").click();                
             });
             $("#ParamsContext").click();
        }
        else if(ui_item.attr("name") == "setVars")
        {
             ui_item.click(function() {
                window.Vars = JSON.parse(atob(ui_item.attr("params")));
                $("#VarsContext").click();                
             });
             $("#VarsContext").click();
        }        
		ui_item.click(function(event) {
			if(event.target.nodeName == 'SELECT')
            {
                return;
            }            
            //showHelp(ui_item);
            
			setTimeout(function(){
				if(!ui_item.hasClass("li-selected"))
				{
					if($("li.li-selected").length > 0)
					{
						var it = $($("li.li-selected")[0]);
						if(it.hasClass("task"))
						{
							restoreTask(it);
							if($("#TaskContext").hasClass("clicked"))
							{
								$("#TaskContext").click();
							}
						}
					}
					$("li").removeClass("li-selected");
					ui_item.addClass("li-selected");
                    $("li[head='" + ui_item.attr("id") + "']").addClass("li-selected");
                    $("li[id='" + ui_item.attr("head") + "']").addClass("li-selected");
                    var controls = $("li.li-selected");
                    if(controls.length > 1)
                    {
                    	var start_elem = controls[0];
                        var end_elem = controls[1];
                        var elem = $(start_elem).next();
                        while(elem.attr("head") != $(start_elem).attr("id")) 
                        {
                        	elem.addClass("li-selected");
                            elem = $(elem).next();
                        } 
						$("#VarsContext").click();
                    }
					if(ui_item.hasClass("task"))
					{
						Task_Backup = window.Task;
						window.Task = JSON.parse(atob(ui_item.attr("params")));
						$("#TaskContext").click();
					}
				}
				else
				{
					if(ui_item.hasClass("task") && $(".li-selected").length == 1)
					{
						restoreTask(ui_item);
						$("#TaskContext").click();
					}
					else
					{
						$("li").removeClass("li-selected");                    
						$("#elementHelp").hide();
						restoreTask(ui_item);
					}					
				}
			},50);						
        });
  }
  
  function initSortable()
  {
    var dragId = "";
    
    $( ".sortable" ).sortable({
      
      items: "li:not(.fixed)",
      start: function( event, ui ) { 
        rotate = false;
      },
      stop: function( event, ui ) { 
        rotate = true;
      },
      /* update function */
      update: function(event, ui) {
        var lis = $('ul.sortable li');
        
        if($(lis[lis.length - 1]).attr("name") != "stop" && $(lis[lis.length - 1]).attr("name") != "start")
        {
            $("li[head='" + $(lis[lis.length - 1]).attr("id") + "']").remove();
            $(lis[lis.length - 1]).remove();            
        }
        
        setTimeout(indent,100);
        
        addClickEvents(ui.item);

      }
    });
  }
  
  function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function initDraggable()
    {
    
        $( ".draggable" ).draggable({
          connectToSortable: ".sortable",
          helper: "clone",
          revert: "invalid",
          
          drag: function( event, ui ) { 
            var lis = $('ul.sortable li');
            if(lis.length < 5)
            {
              $(".sortable li").css("margin-right","10px");
            }
            indent();
            
          },
          start: function( event, ui ) { 
            rotate = false;
            if(ui.helper.attr("name") == "setParams")
            {
                ui.helper.attr("params",btoa(JSON.stringify(Params)));
            }
            if(ui.helper.attr("name") == "setVars")
            {
                ui.helper.attr("params",btoa(JSON.stringify(Vars)));
            }            
          },
          stop: function( event, ui ) { 
            $(".sortable li").css("margin-right","2px");
            indent();
            
            var newelement = $("ul.sortable").find(".draggable");
            
            newelement.attr("id","newElement");
            newelement.removeClass("draggable");
            
            var rid = "ctrl_" + getRandomInt(10000,99999);
            
            if(newelement.attr("name") == "if")
            {
                $("<li name='wrapper' head='" + rid + "' class='if rightRounded'>&nbsp;&nbsp;</li>").insertAfter( "#newElement" );
                newelement.attr("id",rid);
            }
            else if(newelement.attr("name") == "while")
            {
                $( "<li name='wrapper' head='" + rid + "' class='while rightRounded'>&nbsp;&nbsp;</li>" ).insertAfter( "#newElement" );
                newelement.attr("id",rid);
            }
            else if(newelement.attr("name") == "repeat")
            {
                $( "<li name='wrapper' head='" + rid + "' class='repeat rightRounded'>&nbsp;&nbsp;</li>" ).insertAfter( "#newElement" );
                newelement.attr("id",rid);
            }
            else
            {
                newelement.removeAttr("id");
            }
			
            addClickEvents($("li[head='"+rid+"']"));
            rotate = true;
            $("#elementHelp").hide();
          }
        }).click(function(event){showHelp($(event.target));});
    }
    
    
  
  $( function() {
    
    initSortable();
    initDraggable();
    $(".taskPlaceHolder").hide();
  });
  
  </script>

<body onload="setTimeout(moveSimulator,100);" oncontextmenu="return false;">
<script>
    function moveSimulator()
    {
        //$("#sim_controls").width(600);
		var w = 1400;
		var h = 860;
        $("#container").height(h);
        $("#container").width(w);
		var dw = $(window).width();
        $("#container").offset({left:300,top:0});
        
        $("#container").addClass("simulator");
        //$(".dg .main").hide();
        
        
    }
</script>


<script>

var tasks = {};

function generateBookmarklet()
{
    var ul_content = document.getElementById("workflow").outerHTML;
	
    var code = "var ul_content = \'" + ul_content + "\';"; 
    code += "tasks." + $('#activeTask').text() + " = ul_content;";
	w_Vars = JSON.stringify(window.Vars);
	w_Params = JSON.stringify(window.Params);
	w_Task = JSON.stringify(window.Task);
	code += "w_Vars = \"" + btoa(w_Vars) + "\";"; 
	code += "w_Params = \"" + btoa(w_Params) + "\";";
	code += "w_Task = \"" + btoa(w_Task) + "\";";	
	code += "window.Params = JSON.parse(atob(w_Params)); $('#ParamsContext').click();"; 
    code += "window.Vars = JSON.parse(atob(w_Vars)); $('#VarsContext').click();";
	code += "window.Task = JSON.parse(atob(w_Task)); $('#TaskContext').click();";
    code += "document.getElementById(\"workflow\").outerHTML = ul_content;";
    code += "$(\'#activeTask\').text('" + $('#activeTask').text() + "');";
    code += "$(\'#bookmarklet\').text('" + $('#activeTask').text() + "');";
    
    code += "var taskName = \'" + $('#activeTask').text() + "\';";
    code += "var task = $($(\'.taskPlaceHolder\')[0]);if($(\'#tasks\').find(\"li[name=\'" + $('#activeTask').text() + "\']\").length == 0){ task.show();task.attr(\'params\',w_Task);task.attr(\'name\',taskName);task.html(\'<img src=\"img/task.png\" height=\"15\">&nbsp;\' + taskName);task.removeClass(\'taskPlaceHolder\');};";
    code += "initSortable(); populateSelects();";
    
    code += "var task_steps = $(\'#workflow li\');";
    code += "for(var i=1;i<task_steps.length-1;i++){addClickEvents($(task_steps[i]));};$('#TaskContext').click();";   

	code = "javascript:var injected = function(){" + code + "}; injected();";
	
	$("#bookmarklet").attr("href", code);
    $("#bookmarklet").text($("#activeTask").text());
    
}

</script>


<table cellpadding="0" cellspacing="0" style="position: absolute; z-index: 100; padding: 0; margin: 0; width: 100%; height: 100%;">
<tr>
<!-- WORKFLOW -->
<!-- WORKFLOW -->
<td class="workflow" colspan="2" valign="top" style="user-select: none;">
<span class="activeTask" title="Edit task name"><span>âœŽ</span>&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; border-right-width: 1px;" id="activeTask" onclick="$('#activeTask').attr('contenteditable','true');" onfocusout="$('#activeTask').attr('contenteditable','false');">Untitled</span>&nbsp;&nbsp;&nbsp;</span>
<span title="Drag and drop this link to your browser's bookmarks bar to save this task." class="saveButton" onmouseout="$('#bookmarklet').css('color', 'white');rotate = true;" onmouseover="generateBookmarklet(); rotate = false;$('#bookmarklet').css('color', 'grey');">ðŸ’¾ <a id="bookmarklet" href="#" style="color:white;">Untitled</a></span>

</span>
<script>

$('.activeTask').keydown(function(e) {
    // trap the return key being pressed
    var forbidden = [13,32,188,190];
    
    var allowed = true;
    for(var i=0;i<forbidden.length;i++)
    {
        if(forbidden[i] === e.keyCode)
        {
            allowed = false;
            break;
        }
    }
    
    if (!allowed) {
      return false;
    }
  });

function gripper(Params,Vars,action, width)
{
  return new Promise(resolve => {
  if($("#robot_connected").is(":checked"))
    {
        var params = { cmd: action };
        if(action == "action")
        {
            params["width"] = width;
        }
        $.post( "http://localhost:5001/robot", params)
                  .done(function( data ) { console.log( "Response: " + data ); })
                  .always(function() { resolve(20); });
    }
    else
    {
        console.log("Gripper: " + action + ", width: " + width);
		if(action == "close")
		{
			ATTACH = true;
		}
		else
		{
			ATTACH = false;
		}
		setTimeout(function(){resolve(20);},200);
        
    }
  });
}


function driveTo(Params,Vars,target)
{
  return new Promise(resolve => {
    var moving = -1;
    var step = 10;
    if(!$("#robot_connected").is(":checked"))
    {
        var move = function()
        {
            MOVING = true;
            var current = Robot.tcp;
            current.x = parseInt(current.x);
            current.y = parseInt(current.y);
            current.z = parseInt(current.z);
            current.rx = parseInt(current.rx);
            current.ry = parseInt(current.ry);
            current.rz = parseInt(current.rz);
            target.tcp.x = parseInt(target.tcp.x);
            target.tcp.y = parseInt(target.tcp.y);
            target.tcp.z = parseInt(target.tcp.z);
            target.tcp.rx = parseInt(target.tcp.rx);
            target.tcp.ry = parseInt(target.tcp.ry);
            target.tcp.rz = parseInt(target.tcp.rz);
            
            var cont = false;
            
            var setCoord = function(cur,tgt,selector) {
                if(cur != tgt)
                {
                    if(tgt > cur)
                    {
                        $(selector).val(cur + step);
                        if(tgt < cur + step)
                        {
                            $(selector).val(tgt);
                        }
                    }
                    else
                    {
                        $(selector).val(cur - step);
                        if(tgt > cur - step)
                        {
                            $(selector).val(tgt);
                        }
                    }
                    cont = true;
                }
            }
            
            setCoord(current.x, target.tcp.x, "#x");
            setCoord(current.y, target.tcp.y, "#y");
            setCoord(current.z, target.tcp.z, "#z");
            setCoord(current.rx, target.tcp.rx, "#rx");
            setCoord(current.ry, target.tcp.ry, "#ry");
            setCoord(current.rz, target.tcp.rz, "#rz");
            
            if(!cont)
            {
                clearInterval(moving);
                MOVING = false;
                resolve(20);
            }
        }
        moving = setInterval(move,10);
    }
    else
    {
        var limit = 0.2;
        var a = (Params.motion.acceleration < limit)? Params.motion.acceleration: limit; 
        var v = (Params.motion.velocity < limit)? Params.motion.velocity: limit;
        
        
        $.post( "http://localhost:5001/robot", { cmd: "movel", x: target.tcp.x, y: target.tcp.y, z: target.tcp.z, rx: target.tcp.rx, ry: target.tcp.ry, rz: target.tcp.rz, acc: a, vel: v})
          .done(function( data ) { console.log( "Response: " + data ); })
          .always(function() { resolve(20); });
    }
  });
}

async function relativeMove(Params,Vars)
{
	var target = { tcp: {
            x: parseFloat(Robot.tcp.x) + parseFloat(eval(Params.motion.dP.x)),
            y: parseFloat(Robot.tcp.y) + parseFloat(eval(Params.motion.dP.y)),
            z: parseFloat(Robot.tcp.z) + parseFloat(eval(Params.motion.dP.z)),
            rx: parseFloat(Robot.tcp.rx) + parseFloat(eval(Params.motion.dR.rx)),
            ry: parseFloat(Robot.tcp.ry) + parseFloat(eval(Params.motion.dR.ry)),
            rz: parseFloat(Robot.tcp.rz) + parseFloat(eval(Params.motion.dR.rz)) 
            }
        };
	return await driveTo(Params,Vars,target);
}

function userInput(obj)
{
    for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
            try
            {
                var ui = JSON.parse(obj[key]);
                if(ui.ask != null)
                {
                    var res = prompt(ui.ask, "");
                    var val = null;
                    try
                    {
                        val = parseInt(res);
                        console.log("integer");
                    }
                    catch(e)
                    {
                        try
                        {
                            val = parseFloat(res);
                            console.log("float");
                        }
                        catch(e)
                        {
                            val = res;
                            console.log("string");
                        }
                    }
                    obj[key] = val;
                }
            }
            catch(e)
            {
                 //console.log(e);   
            }
        }
    }
}

const JavaScriptCodeGenerator = 
{
    "gripperClose": function(step)
    {
		return "await gripper(Params,Vars,'close');"
    },
    "gripperOpen": function(step)
    {
        return "await gripper(Params,Vars,'open');"
    },
    "gripperAction": function(step)
    {
		return "await gripper(Params,Vars,'action');"
    },
    "moveTo": function(step)
    {
        var code = "var target = " + step.attr("params") + "; await driveTo(Params,Vars,target);";
        return code;
    },
    "moveRelative": function(step)
    {
        var code = "await relativeMove(Params,Vars);";
        return code;
    },
    "repeat": function(step)
    {
        return "for(var i=0; i < eval(" + step.find("select").val() + "); i++){";
    },
	"while": function(step)
    {
        return "while(eval(" + step.find("select").val() + ")){";
    },
    "if": function(step)
    {
        return "if(eval(" + step.find("select").val() + ")){";
    },
    "elseif": function(step)
    {
        return "} else if(eval(" + step.find("select").val() + ")){";
    },
    "else": function(step)
    {
        return "} else {";
    },
    "wrapper": function(step)
    {
        return "};";
    },
    "setParams": function(step)
    {
		return "Params = " + atob(step.attr("params")) + "; \n"; // TODO: set jsoneditor params here too
    },
    "setVars": function(step)
    {
		var code = "var v = " + atob(step.attr("params")) + "; \n";
        code += "Vars = {...Vars, ...v};";
		return code;
        //return "Vars = " + step.attr("params") + ";";
    },
	/*
    "export": function(step)
    {
        var imp = {};
        imp[step.attr("params")] = window.Vars[step.attr("params")];
        return "Vars = {...Vars, ...JSON.parse(" + JSON.stringify(imp) + ")};";
        //return "Vars = " + step.attr("params") + ";";
    },
	*/
	"eval": function(step)
    {
        return "eval(" + step.find("select").val() + ");";
    },
	"funcEnd": function(step)
    {
        var code = "}; await " + step.attr("funcName") + "(Params,Vars);";
		if(step.highlight)
		{
			code += "$('li[step=\"" + step.attr("taskId") + "\"]').removeClass('li-executing');";
		}
		return code;
    }
}
var sikuliCode = "";
const SikuliCodeGenerator = 
{
	"gripperClose": function(step)
    {
		return "";
    },
    "gripperOpen": function(step)
    {
        return "";
    },
    "gripperAction": function(step)
    {
		return "";
    },
    "moveTo": function(step)
    {
		var p = JSON.parse(step.attr("params"));
        var code = "moveTo(" + p.tcp.x + ", " + p.tcp.y + ", " + p.tcp.z + ", " + p.tcp.rx + ", " + p.tcp.ry + ", " + + p.tcp.rz + ", " + Params.motion.velocity + ", " + Params.motion.acceleration + ");\n";
        sikuliCode += code;
		return "";
    },
    "moveRelative": function(step)
    {
        return "";
    },
    "repeat": function(step)
    {
		sikuliCode += "start_repeat(\"" + eval(step.find("select").val()) + "\");\n";
        return "";
    },
	"while": function(step)
    {
        sikuliCode += "start_while(\"" + eval(step.find("select").val()) + "\");\n";
        return "";
    },
    "if": function(step)
    {
		sikuliCode += "start_if(\"" + eval(step.find("select").val()) + "\");\n";		
		return "";
    },
    "elseif": function(step)
    {
        return "} else if(eval(" + step.find("select").val() + ")){";
    },
    "else": function(step)
    {
        sikuliCode += "add_else();\n";
		return "";
    },
    "wrapper": function(step)
    {
        /*var code = "";
		if(step.hasClass("if"))
		{
			code = "wrap();\n";
		}
		else // ... while, repeat, etc.
		{
			//...
		}
        sikuliCode += code;
		*/
		sikuliCode += "wrap();\n";
		return "";
    },
    "setParams": function(step)
    {
		return "Params = " + atob(step.attr("params")) + "; userInput(Params);"; // TODO: set jsoneditor params here too
    },
    "setVars": function(step)
    {
		var code = "var v = " + atob(step.attr("params")) + ";";
        code += "Vars = {...Vars, ...v}; userInput(Vars); ";
		return code;
        //return "Vars = " + step.attr("params") + ";";
    },
	/*
    "export": function(step)
    {
        var imp = {};
        imp[step.attr("params")] = window.Vars[step.attr("params")];
        return "Vars = {...Vars, ...JSON.parse(" + JSON.stringify(imp) + ")};";
        //return "Vars = " + step.attr("params") + ";";
    },
	*/
	"eval": function(step)
    {
        return "eval(" + step.find("select").val() + ");";
    },
	"funcEnd": function(step)
    {
        
    }
}


var generator = JavaScriptCodeGenerator;

function getRandInt(min, max) {
  return Math.floor(Math.random() * (max - min) ) + min;
}

var step_count = 0;

function generateJSCode(highlight = true, execProg = true)
{
	step_count = 0;
	var steps = jQuery.makeArray($("#workflow li"));
	var code = "";
	
	for(var i=1;i<steps.length-1;i++)
    {
        var step = $(steps[i]);
		step["highlight"] = highlight;
		
		step.attr("step", "step_" + step_count);
		if(step.hasClass("task"))
        {
            if(tasks[step.attr("name")] == null)
            {
                alert("Please load task '" + step.attr("name") + "' first.");
                return;
            }
			
            var task_steps = jQuery.makeArray($($.parseHTML(tasks[step.attr("name")])).find('li'));
            // remove start li
            task_steps.shift();
            // remove stop li
            task_steps.pop();
			
			var funcName = "t_" + getRandInt(1000,9999);
			
			task_steps.push($("<li taskId='" + step.attr("step") +  "' name='funcEnd' funcName='" + funcName + "'>" + funcName + "</li>")[0]);
			
			steps.splice(i+1, 0, ...task_steps);
			
			if(highlight)code += "$('li[step=\"" + step.attr("step") + "\"]').addClass('li-executing');\n";
			code += "var " + funcName + " = async function(Params,Vars){ \n";
			var p = atob(step.attr('params'));
			code += "Task = JSON.parse(" + JSON.stringify(p) + ");";
        }
        else
        {
			console.log(step.attr("name"));
            var exclude = ["elseif", "if", "else", "wrapper", "while", "repeat"];
			if(!exclude.includes(step.attr("name"))) 
            {
              if(highlight) code += "$('li[step=\"" + step.attr("step") + "\"]').addClass('li-executing');\n";
            }
            code += generator[step.attr("name")](step) + "\n";
			if(!exclude.includes(step.attr("name"))) 
            {	
          		if(highlight) code += "$('li[step=\"" + step.attr("step") + "\"]').removeClass('li-executing');\n";
            }
        }
		step_count++;
    }
    
    if(execProg) code = "var execProgram = async function() { " + code + "};\n";
	if(execProg) code += "execProgram();\n";
    
    console.log(code);
    
	
	return code;	
}

function startExecution()
{
	$("li").removeClass("li-selected");
    
	var code = generateJSCode();
    
    eval(code);
}

/*
function startExecution()
{
	step_count = 0;
	$("li").removeClass("li-selected");
    var steps = jQuery.makeArray($("#workflow li"));
    var code = "";
	
    for(var i=1;i<steps.length-1;i++)
    {
        var step = $(steps[i]);
		
		step.attr("step", "step_" + step_count);
		if(step.hasClass("task"))
        {
            if(tasks[step.attr("name")] == null)
            {
                alert("Please load task '" + step.attr("name") + "' first.");
                return;
            }
			
            var task_steps = jQuery.makeArray($($.parseHTML(tasks[step.attr("name")])).find('li'));
            // remove start li
            task_steps.shift();
            // remove stop li
            task_steps.pop();
			
			var funcName = "func_" + getRandInt(10000,99999);
			
			task_steps.push($("<li taskId='" + step.attr("step") +  "' name='funcEnd' funcName='" + funcName + "'>" + funcName + "</li>")[0]);
			
			steps.splice(i+1, 0, ...task_steps);
			
			code += "$('li[step=\"" + step.attr("step") + "\"]').addClass('li-executing');";
			code += "var " + funcName + " = async function(Params,Vars){ ";
			var p = atob(step.attr('params'));
			code += "Task_Backup = Task; Task = JSON.parse(" + JSON.stringify(p) + ");";
        }
        else
        {
			console.log(step.attr("name"));
            var exclude = ["elseif", "if", "else", "wrapper", "while", "repeat"];
			if(!exclude.includes(step.attr("name"))) 
            {
              code += "$('li[step=\"" + step.attr("step") + "\"]').addClass('li-executing');";
            }
            code += generator[step.attr("name")](step);
			if(!exclude.includes(step.attr("name"))) 
            {	
          		code += "$('li[step=\"" + step.attr("step") + "\"]').removeClass('li-executing');";
            }
        }
		step_count++;
    }
    
    code = "var execProgram = async function() { " + code + "}; execProgram();";
    
    console.log(code);
    
    eval(code);
}
*/
function fallbackCopyTextToClipboard(text) {
  var textArea = document.createElement("textarea");
  textArea.value = text;
  
  // Avoid scrolling to bottom
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    var successful = document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    console.log('Fallback: Copying text command was ' + msg);
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }

  document.body.removeChild(textArea);
}
function copyTextToClipboard(text) {
  if (!navigator.clipboard) {
    fallbackCopyTextToClipboard(text);
    return;
  }
  navigator.clipboard.writeText(text).then(function() {
    console.log('Async: Copying to clipboard was successful!');
  }, function(err) {
    console.error('Async: Could not copy text: ', err);
  });
}

function generateSikuliCode()
{
	var boilerplate = "# -*- coding: utf-8 -*-\n";
	boilerplate += "from URSIM5e import *\n";
	boilerplate += "initContext();\n";
	
	sikuliCode = "";
	generator = SikuliCodeGenerator;
	
	startExecution();	
	
	copyTextToClipboard(boilerplate + sikuliCode);
	
	generator = JavaScriptCodeGenerator;
	
	$("#elementName").text("Sikuli");
    $("#elementHelp").html("<hr size='1'>The Sikuli code was successfully generated and copied to the clipboard. You can now paste that code into Sikuli. Sikuli is a GUI automation tool that can be used to generate code in Polyscope. Click here for more information.");
    $("#elementHelp").show();
	setTimeout(function(){ $("#elementHelp").show(); },3000);
}

</script>

<ul id="workflow" style="user-select: none; padding-left: 10px; padding-top: 10px;" class="sortable">
  <li name="start" onclick="startExecution()" class="fixed rightRounded" style="background-color: black; border-color: lightgrey; border-style: outset; border-width: 1.5px 1.9px 1.9px 1.5px; color: white;">
  &nbsp;start&nbsp;&nbsp;<font color="DarkSeaGreen">â–¶</font>
  </li>
  <li name="stop" class="leftRounded" style="background-color: black; color: white; display: table-cell; vertical-align: middle; border-color: lightgrey; border-style: outset; border-width: 1.5px 1.9px 1.9px 1.5px;">&nbsp;stop&nbsp;&nbsp;<font color="LightCoral">â—¼</font></li>
</ul>
<script>
$('#activeTask').on('DOMSubtreeModified',function(){
  indent();
});

var scrolling = true;
</script>
</td>
</tr>
<tr>
<td colspan="3" valign="bottom" height="100" style="background:rgba(255, 255, 255,0.3);">
<script>
function toggleHelp()
{
	if($('#elementHelp').is(":hidden"))
	{
		$('#elementHelp').show();
		$('#elementName').attr("title","Hide help");
	}
	else
	{
		$('#elementHelp').hide();
		$('#elementName').attr("title","Show help");
	}
}
</script>

<div id="help" class="helpBox" style="user-select: none; width: 450px;color: grey;font-size: 12px;padding: 22px;font-family: 'Big Shoulders Text', Arial Narrow; font-size: 14px;font-family: Arial Narrow;padding-bottom: 15px;">
<font color="steelblue" size="3">ðŸ›ˆ</font>&nbsp;&nbsp;<b><a href="#"><span id="elementName" onclick="toggleHelp();" title="Show help">Help</span></a></b><span id="elementHelp" style="display: none;" onclick="toggleHelp();">
<hr size="1" />
Drag and drop elements from the <b>Actor and Task Library</b> ðŸ¡– to the workflow pane ðŸ¡” and place them anywhere between the <b>start</b> and <b>stop</b> elements. Use the keyboard arrows to move the simulator to create a robot task. Click on an empty surface and drag the mouse to rotate the simulator. Keep the <b>ALT</b> key pressed to manually move the robot by dragging its head.
<br><br>
To save a task, first rename it by clicking on <b>Untitled</b> ðŸ¡‘ and edit its name. Then hover over the floppy disk icon ðŸ’¾ and drag the task bookmark to your browser's bookmarks bar. To load the task, just click on that browser bookmark. Tasks can also be used within other tasks. When loading a task, it will be also added to the <b>Actor and Task Library</b> ðŸ¡–
</span>
  </div>
</td>

</tr>
<tr>

<td align="left" style="user-select: none; padding-top: 4px;padding-bottom: 0px;padding-left:6px; width: 330px;" onmouseover="scrolling = false;" onmouseout="scrolling = true;" class="toolset embossed-light" valign="top"><table cellspacing="0" cellpadding="0"><tr><td><span id="RobotContext" title="View the robot's state ('Robot' object)" class="button clicked"><img src="img/mechanical-arm2.png" height="13">&nbsp;Robot</span></td><td><span id="ParamsContext" title="View/set robot parameters ('Params' object)" class="button"><img src="img/params.png" height="13">&nbsp;Parameters</span></td><td><span id="VarsContext" title="View/define application variables ('Vars' object)" class="button"><img src="img/vars.png" height="13">&nbsp;Variables</span></td>
<td><span id="TaskContext" title="View/define parameters for the current task" class="button"><img src="img/task.png" height="13">&nbsp;Task</span></td></tr></table></div><hr style="margin-top: 7px;">
<div id="jsoneditor" style="width: 100%; height: 280px;"></div>
</td>
<script>
    $(".button").click(function() {
      var buttons = $(".button");
      for(var i=0;i<buttons.length;i++)
      {
        $(buttons[i]).removeClass("clicked");
      }
      $(this).addClass("clicked");
      
      var context = $(".button.clicked").attr("id");
	  
	  $("#jsoneditor").show();
	  
      
      if(context == "RobotContext")
      {
        editor.setMode("view");
        editor.set(Robot);
      }
      else if(context == "VarsContext")
      {
        editor.setMode("tree");
        editor.set(Vars);
      }
      else if(context == "ParamsContext")
      {
        editor.setMode("tree");
        editor.set(Params);
      }
	  else if(context == "TaskContext")
      {
        editor.setMode("tree");
        editor.set(Task);
      }
	  else 
      {
        editor.setMode("view");
        editor.set(Robot);
      }      
      
      hideEditorBars();
      editor.expandAll();
      
      if(context != "RobotContext")
      {
          $("table.jsoneditor-tree").css("margin-left","-22px");          
      }
    });


	function showCode()
	{
	    //$("#jsoneditor").hide();
		if($("#CodeContext").hasClass("clicked"))
		{
			$("#codeeditor").hide();
			$("#CodeContext").removeClass("clicked");
		}
		else
		{
			$("#codeeditor").show();
			$("#CodeContext").addClass("clicked");
			var code = generateJSCode(false, false);
			if(code.length == 0)
			{
				code += "// this task is empty";
			}
			
			code = js_beautify(code) + "\n";
			
			var ce = ace.edit("codeeditor");
			ce.setOptions({
				wrap: true,   // wrap text to view
				
			});
			
			ce.setValue(code, -1);
			//ce.setTheme("ace/theme/monokai");
			ce.getSession().setMode("ace/mode/javascript");
			ce.container.style.background = "rgba(76, 175, 80, 0.0)";		
			ce.renderer.setShowGutter(false);
		}
	}

</script>

<!-- ACTOR LIBRARY -->
<td class="toolset embossed-light" style="user-select: none;" valign="top">
<table width="100%" cellspacing="0" cellpadding="0">
<tr>
<td align="left"><h1>Actor and Task Library</h1></td>
<td align="right"><span id="CodeContext" onclick="showCode();" style="margin-top: -2px;margin-bottom:0;margin-right: 12px; padding-left: 3px; padding-right: 2px;" title="Show / hide the source code of the current task" class="codebutton"><img src="img/code.png" height="18"></span></td>
<!--
<td align="right" valign="top"><a title="Click here to copy Sikuli code to the clipboard." href="javascript:generateSikuliCode();" style="font-size:20px;">ðŸ“‹</a>&nbsp;&nbsp;&nbsp;</td>
-->
</tr>
</table>
<hr>
<table width="100%">
<tr><td valign="top">
<ul id="actors" style="user-select: none;">
  <li id="wp" name="moveTo" class="draggable actor rightRounded" style="padding-right: 45px;">move to</li>
  <li name="moveRelative" title="Will move relative to the current position by the amount specified by the dP and dR parameters." class="draggable actor rightRounded" style="padding-top: 7px;padding-bottom: 7px;"><font size="4">â¥…</font>dP <font size="4">â¤½</font>dR</li>
  <li name="gripperOpen" class="draggable actor rightRounded"><table height="100%" cellpadding="0" cellspacing="0"><tr><td><img name="gripperOpen" src="img/open.png" height="15"></td><td valign="top" name="gripperOpen">&nbsp;open</td></tr></table></li>
  <li name="gripperClose" class="draggable actor rightRounded"><table height="100%" cellpadding="0" cellspacing="0"><tr><td><img name="gripperClose" src="img/close.png" height="15"></td><td valign="top" name="gripperClose">&nbsp;close</td></tr></table></li>
  <li name="gripperAction" class="draggable actor rightRounded"><table height="100%" cellpadding="0" cellspacing="0"><tr><td><img name="gripperAction" src="img/gripper.png" height="15"></td><td name="gripperAction" valign="top">&nbsp;action</td></tr></table></li>
   
  
</ul>
<ul id="controls">
  <li name="if" class="draggable if rightRounded" style="padding-right: 1px;">if<select name="if-select" class="if-cond condition"></select></li>
  <li name="else" class="draggable if rounded">else</li>
  <li name="elseif" class="draggable if rounded" style="padding-right: 1px;">elseif<select name="elseif-select" class="if-cond condition"></select></li>
  <li name="while" class="draggable while rightRounded" style="padding-right: 1px;">while<select name="while-select" class="while-cond condition"></select></li>
  <li name="break" class="draggable break leftRounded">break</li>
  <li name="repeat" class="draggable repeat rightRounded" style="padding-right: 1px;">repeat<select name="repeat-select" class="repeat-cond counter"></select></li>
</ul>
<ul id="settings">
  <li name="setParams" title="Sets the robot parameters to their current value in the Parameters tab." class="draggable settings rightRounded" style="padding-right: 7px; padding-top: 8px; padding-bottom: 6px; background-color: whitesmoke;"><table height="100%" cellpadding="0" cellspacing="0"><tr><td style="padding-left: 2px;padding-right: 1px;"><img name="setParams" src="img/params.png" height="13"></td><td valign="top" name="setParams"></td></tr></table></li>
  <li name="setVars" title="Sets the contents of the Vars object as currently defined in the Variables tab." class="draggable settings rightRounded" style=" background-color: whitesmoke;"><table height="100%" cellpadding="0" cellspacing="0"><tr><td style="padding-right: 1px;"><img name="setVars" src="img/vars.png" height="14"></td><td valign="top" name="setVars"></td></tr></table></li>
  <li name="eval" title="Evaluates the expression indicated in the drop-down list." class="draggable settings rightRounded" style="padding-right: 1px;"><table height="100%" cellpadding="0" cellspacing="0"><tr><td name="eval">âŒ¨</td><td valign="top" name="eval"><select name="eval-select" class="eval expression"></select></td></tr></table></li>  
</ul>
<ul id="tasks">
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>
<li name="taskPlaceHolder" class="taskPlaceHolder draggable rightRounded task">taskPlaceHolder</li>

</ul>
</td>
<td align="right">
<div id="codeeditor" style="display: hidden; margin-top: -10px; padding: 0px; width: 400px; height: 285px;"></div>
</td>
</tr></table>
</td>
</tr>

</table>
    <script>
    $(".taskPlaceHolder").hide();
        function hideEditorBars()
        {
            $(".jsoneditor-menu").hide();
            $(".jsoneditor-navigation-bar").hide();
            $(".jsoneditor-mode-tree").css("border-width","0");
        }
        var Robot = {
            "tcp": {"x" : 0, "y" : 0, "z" : 0, "rx" : 0, "ry" : 0, "rz" : 0},
            "axes": [0,0,0,0,0,0]            
        };
        
        var Vars  = {
            "count" : 20,
			"expr"  : "alert(\'hello\')",
            "cond1" : "Params.effector.width == 50",
            "cond2" : "Vars.count == 20",
            "cond3" : "Robot.tcp.x == 150"
        };
        
        var Params  = {
            "motion": {"acceleration": 0.05, "velocity": 0.05,"dP": {x:0,y:0,z:0}, "dR": {rx:0,ry:0,rz:0}},
            "effector": {"width": 80, "force": 30}
        };
		
		var Task = {
			"boolParam":true,
			"intParam":0,
			"stringParam":"setMe",			
		};
        
        
        // create the editor
        const container = document.getElementById("jsoneditor");
        const options = {
            onEditable: function (node) {
                // node is an object like:
                //   {
                //     field: 'FIELD',
                //     value: 'VALUE',
                //     path: ['PATH', 'TO', 'NODE']
                //   }
                switch (node.field) {
                  case 'motion':
                    return {
                      field: false,
                      value: true
                    }
                  case 'effector':
                    return {
                      field: false,
                      value: true
                    }
                  case 'acceleration':
                    return {
                      field: false,
                      value: true
                    }
                  case 'velocity':
                    return {
                      field: false,
                      value: true
                    }
                  case 'dP':
                    return {
                      field: false,
                      value: true
                    }
                  case 'dR':
                    return {
                      field: false,
                      value: true
                    }
                  default:
                    return (($(".button.clicked").attr("id") == "RobotContext")? false : true);
                }
            },
            onChange: function () {
                var context = $(".button.clicked").attr("id");
                if(context == "VarsContext")
                {
                    Vars = editor.get();
                }
                else if(context == "ParamsContext")
                {
                    Params = editor.get();
                }
                else if(context == "TaskContext")
                {
                    Task = editor.get();
                }

                
                populateSelects();
            },
            mode: "view"
        };

        /* color: #5D6D7E */
        const editor = new JSONEditor(container, options);
        editor.set(Robot);
        populateSelects();
		
		hideEditorBars();
        
    </script>
 
<div id="trash" style="padding-left: 5px; padding-top: 2px; font-size: 36px;display: absolute; z-index: 101; color: slategrey;"><a href="javascript:$('.li-selected').remove();indent();" title="Drag actors here to delete them from the workflow.">ðŸ—‘</a></div> 
<script>
indent();
</script>

<div id="sim_controls" align="center" class="sim_controls" onmouseover="rotate = false;" onmouseout="rotate = true;">
Connect to robot &nbsp;<label class="switch"><input id="robot_connected" type="checkbox"><span class="slider round"></span></label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

	x: <input type="number" class="sim_input" id="x" step="1" value="300"></input>&nbsp;
	y: <input type="number" class="sim_input" id="y" step="1" value="300"></input>&nbsp;
	z: <input type="number" class="sim_input" id="z" step="1" value="300"></input>&nbsp;
	rx (roll): <input type="number" class="sim_input" id="rx" step="1" value="0"></input>&nbsp;
    ry (pitch): <input type="number" class="sim_input" id="ry" step="1" value="180"></input>&nbsp;
	rz (yaw): <input type="number" class="sim_input" id="rz" step="1" value="0"></input>
	 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>a s s e m <a href="https://github.com/CoMeMak/assembly" title="Source code and more information on GitHub" target="_blank"><font color="steelblue">â›†</font></a><font color="grey"> b l y <sup><font size="1">alpha</font></sup></b>&nbsp;&nbsp;&nbsp;</font>
	</div>



<!-- three_js container -->
  <div id="container" class="simulator" style="float: right;"></div>

  <script type="text/javascript">
    var hmi = null;
    var debug = {}
    requirejs.config({
      // urlArgs: "bust=" + (new Date()).getTime(),
      baseUrl: 'js',
      paths: {
        State: '../vendor/state/State',
        Kinematic: 'InverseKinematic'
      },
    });

    require(['Hmi'], function(Hmi) {
      hmi = new Hmi()
    });
    
    
  </script>


<script>

var mouseDown = false;
$(document).mousedown(function() {
    mouseDown = true;
}).mouseup(function() {
    mouseDown = false;  
});


var shifted = false;
document.onkeydown = function(event) {
  if (event.altKey) 
  {
    shifted = true;
  } 
  else 
  {
    shifted = false;
  }
}

document.onkeyup = function(event) { shifted = false; $(".toolset").click();}

var frame = 0;
var MOVING = false;
function setRobotVars()
{
    $(".dg .main").hide();
    
    frame++;
    
    if($("#robot_connected").is(":checked"))
    {
        $(".sim_input").prop( "disabled", true );
    }
    else
    {
        $(".sim_input").prop( "disabled", false ); 
    }
    var robot_connected = $("#robot_connected").is(":checked");
    if(robot_connected && frame % 3 == 0)
    {
        
        $.get( "http://localhost:5001/robot", function( data ) {
              console.log(JSON.stringify(data));
              $("#x").val(data.x.toFixed(2));
              $("#y").val(data.y.toFixed(2));
              $("#z").val(data.z.toFixed(2));              
              $("#rx").val(data.rx.toFixed(2));
              $("#ry").val(data.ry.toFixed(2));
              $("#rz").val(data.rz.toFixed(2));              
        })
        .fail(function() {
          $( "#robot_connected" ).prop( "checked", false );
          $("#elementName").text("Error");
          $("#elementHelp").html("<hr size='1'>Cannot connect to the robot! There is no service running at: http://localhost:5001/robot");
          $("#elementHelp").show();
        });
    }
        Robot.tcp.x = $("#x").val();
        Robot.tcp.y = $("#y").val();
        Robot.tcp.z = $("#z").val();
        Robot.tcp.rx = $("#rx").val();
        Robot.tcp.ry = $("#ry").val();
        Robot.tcp.rz = $("#rz").val();
        
        var tcp = {x:0,y:0,z:0,rx:0,ry:0,rz:0};
        
        tcp.x = $("#x").val() / 100;
        tcp.y = $("#y").val() / 100;
        tcp.z = $("#z").val() / 100;
        tcp.rx = $("#rx").val() * 0.0174533;
        tcp.ry = $("#ry").val() * 0.0174533;
        tcp.rz = $("#rz").val() * 0.0174533;
        
        if(hmi != null)
        {
            if(shifted && !robot_connected)
            {
                $("#elementHelp").hide();
                $(".simulator").css('z-index', '1000');
                var pose = hmi.getCoords().pose;
                $("#x").val((pose.x * 100).toFixed(2));
                  $("#y").val((pose.y * 100).toFixed(2));
                  $("#z").val((pose.z * 100).toFixed(2));              
                  $("#rx").val((pose.rx * 57.2958).toFixed(2));
                  $("#ry").val((pose.ry * 57.2958).toFixed(2));
                  $("#rz").val((pose.rz * 57.2958).toFixed(2));
            }
            else
            {
                $(".simulator").css('z-index', '-1000');
                hmi.setCoords(tcp);
            }
            var degs = hmi.getCoords().axes;
            for(var i=0;i<degs.length;i++)
            {
                degs[i] = parseFloat(degs[i] * 57.2958).toFixed(2);
            }
            Robot.axes = degs;
        }
        
        
    var context = $(".button.clicked").attr("id");
    if(context == "RobotContext")
    {    
        $("#RobotContext").click();
    }
	
    if(mouseDown == false && frame % 10 == 0)
    {
        if(document.getElementsByTagName("canvas") != null && !MOVING)
        {
            var snapshot = document.getElementsByTagName("canvas")[0].toDataURL("image\png",0.1);  
			var sel = "#wp";
			
            
			$(sel).css("background-color","");
            $(sel).css("background-repeat", "no-repeat");
            $(sel).css("background-image","url('" + snapshot + "')");        
            $(sel).css("background-size", "80px 50px");
            $(sel).css("background-position", "30px -0px");
            var params = {};
            params["tcp"] = Robot.tcp;
            //params["motion"] = Params.motion;
            $(sel).attr("params",JSON.stringify(params));
            $(sel).attr("title","Will move to x: " + params.tcp.x + ", y: " + params.tcp.y + ", z: " + params.tcp.z + ", rx: " + params.tcp.rx  + ", ry: " + params.tcp.ry + ", rz: " + params.tcp.rz);
        }
    }
    /*
    if($(".li-selected").attr("name") == "setVars")
    {
        $(".li-selected").attr("params",btoa(JSON.stringify(Vars)));
    }
    else if($(".li-selected").attr("name") == "setParams")
    {
        $(".li-selected").attr("params",btoa(JSON.stringify(Params)));
    }*/
}
    

setInterval(setRobotVars,100);
</script>

<script>
	function generateForm(p)
	{
		var html = "<div id='TASK_PARAMS' class='task_params task'><table>";
		for (var key in p) {
			if (p.hasOwnProperty(key)) {
				console.log(key + " -> " + p[key]);
				html += "<tr><td>" + key + "</td><td>" + "<input class='sim_input' style='width: 100px;' type='text' id='TASK_PARAMS_" + key + "' value='" + p[key] + "'/></td></tr>";
			}
		}
		html += "</table></div>";		
		$("body").append($(html));
		
	}
</script>

</body>
</html>
